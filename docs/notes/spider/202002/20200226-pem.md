---
title: 安装SSL证书到android设备
date: 2020-02-26
sidebar: 'auto'
categories:
 - 爬虫
tags:
 - 安卓
 - 证书
---

## Android上的SSL证书

### Android 4.0之前
在`/system/etc/security/cacert.bks`文件中含有所有系统级的CA证书，需要将自己的证书添加到`cacert.bks`文件里面。

### 在Android 4.0 和 ６.0 之间
在`/system/etc/security`目录下的所有证书文件都会被信任。
但是，用户可以添加自己的用户证书到`/data/misc/keychain/certs-added`目录。
在这里，系统证书跟用户证书都被信任，这是最方便的地方。

### 在Android 7.0之后
在这之后，默认情况下系统不再信任用户证书。但是如果是自己的应用，那么可以在AndroidManifeset.xml里配置可以信任用户证书。
如果是抓包别人的应用，这种情况下是抓不到包的。

## 制作并安装Android的系统证书
对于Android 7.0之后的系统，我们想要让系统信任我们的证书，那么我们就得想办法安装证书到Android的系统证书文件下。

### 获得证书的hash值
打开下载的`fiddle`或`charles`（或者其他抓包工具的pem证书）的pem证书文件路径，在该目录下执行命令获取证书的hash值:
```
openssl x509 -inform PEM -subject_hash_old -in XXX.pem | head -1

# 结果：
7bd7be8d(charles)
```
注意，要用`-subject_hash_old`选项，而不是`-subject_hash`，这样才会得到`openssl 0.9`兼容的hash值。

### 生成文件名以.0结尾android证书文件
```
cat XXX.pem > 7bd7be8d.0
openssl x509 -inform PEM -text -in XXX.pem -noout >>  7bd7be8d.0
```

### 最后
将生成后的`7bd7be8d.0`证书文件放到`/system/etc/security/cacerts/`文件目录下即可，这样就能在`设置`里搜索`"信任的凭据"`里查看到。
就能正常抓取https请求了。
